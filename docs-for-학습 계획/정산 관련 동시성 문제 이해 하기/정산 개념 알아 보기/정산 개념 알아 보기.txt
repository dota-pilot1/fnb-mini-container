================================================================
정산(Settlement) 개념 정리
================================================================

■ 한 줄 요약
  "돈 계산 마감" — 일정 기간/조건으로 묶인 매출 데이터를
  합산하고 확정해서 회계 시스템에 기록하는 작업


================================================================
1. 정산이란?
================================================================

  편의점 하루 영업 예시:
  ┌─────────────────────────────────────┐
  │ 손님 A → 김밥    2,000원  카드 결제 │
  │ 손님 B → 음료    1,500원  현금 결제 │
  │ 손님 C → 과자    3,000원  카드 결제 │
  └─────────────────────────────────────┘
  영업 종료 후:
    "오늘 카드로 얼마 들어왔나?"
    "현금은 얼마나 남아 있어야 하나?"
    "카드사에서 실제로 입금되는 금액이 맞나?"
    → 이걸 확인하고 기록하는 것이 정산


================================================================
2. 정산의 묶음 기준 (정산 단위)
================================================================

  일 단위 (일마감)
    → 오늘 하루 매장별 매출 합산
    → 카드사 승인 건수/금액 대조
    → 매일 영업 종료 후 실행

  월 단위 (월마감)
    → 이번 달 전체 합산
    → SAP에 월별 회계 전표 생성
    → 급여, 임대료 등 비용과 대조

  매장별 / 브랜드별
    → 특정 매장만, 또는 특정 브랜드 전체

  정산 실행 조건 파라미터 예시:
    - 매장 코드
    - 정산 기준일 (일/월)
    - 결제 수단 (카드/현금)

  → 이 조건으로 묶인 데이터가 "한 번의 정산 단위"


================================================================
3. 대기업(CJ프레시웨이) 정산 흐름
================================================================

  전국 수백 개 매장 POS 결제 데이터
    → 본사 서버로 전송          (PosSalesReg)
    → 카드사별 승인 금액 대조   (CrdtCardAck)
    → SAP(회계 시스템)에 전표 생성
    → 최종적으로 "오늘 전국 매출 얼마" 확정


================================================================
4. 동시성 문제가 생기는 이유
================================================================

  [매출 데이터 테이블]
  매출ID  매장   결제수단  금액    정산여부
    001   강남점  카드    2,000   N
    002   강남점  현금    1,500   N
    003   강남점  카드    3,000   N

  문제 시나리오:
    담당자 A: 강남점 정산 클릭
      → 001, 002, 003 조회 → 정산여부 N 확인

    담당자 B: (동시에) 강남점 정산 클릭
      → 001, 002, 003 조회 → 아직 N (A가 아직 안 끝남)

    A: 정산 처리 완료 → 정산여부 Y, SAP 전표 생성
    B: 정산 처리 완료 → 또 Y, SAP 전표 또 생성
      → 같은 매출이 두 번 SAP에 올라감 = 이중 정산 발생

  충돌 조건:
    - 같은 매장 + 같은 날짜 조건으로 동시 실행할 때
    - 매장이 다르면 데이터가 달라서 충돌 없음

  핵심 해결책:
    SELECT FOR UPDATE
    → "내가 이 데이터 보는 동안 다른 사람 손대지 마"
    → 먼저 잡은 사람이 처리 완료할 때까지 대기

================================================================

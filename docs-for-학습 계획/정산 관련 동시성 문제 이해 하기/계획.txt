================================================================
학습 계획 — 정산 관련 동시성 문제 이해하기
================================================================

■ 목표
  실무 정산 코드(PosSalesReg, CrdtCardAck 등)의 동시성 문제를
  분석하고, 미니 프로젝트에서 해결 방법을 직접 구현해보기

■ 참고 문서
  - docs-for-동시성 문제 (정산)/주요 로직 분석/실무 프로젝트 동시성 문제 분석.txt
  - docs-for-동시성 문제 (정산)/백엔드 파일/

----------------------------------------------------------------

1단계 — 실무 코드 문제 분석 (읽기/이해)
----------------------------------------------------------------
  [ PosSalesReg — 매출 정산 ]
  - 6단계 트랜잭션 + SAP API 호출이 같은 @Transactional 안에 있음
  - SAP 타임아웃(5분) 동안 DB 커넥션 점유
  - 같은 매출 데이터 동시 정산 시 데이터 꼬임 가능 (SELECT FOR UPDATE 없음)
  - SAP 중복 호출 시 이중 정산 위험 (멱등성 없음)

  [ CrdtCardAck — 신용카드 정산 ]
  - Check-Then-Act 패턴: 조회 후 없으면 INSERT
  - 조회~삽입 사이 락 없음 → 동시 요청 시 중복 INSERT 가능

  [ MnulCustSalesReg — 수기 매출 ]
  - GdohRegCnclAprv — 시재 정산

  [ 학습 포인트 ]
  - 왜 문제가 되는지 시나리오로 이해
  - 트랜잭션 경계, 커넥션 점유 개념


2단계 — 해결 방법 이론 정리
----------------------------------------------------------------
  - 트랜잭션 분리: 외부 API 호출을 트랜잭션 밖으로
  - SELECT FOR UPDATE (비관적 락): 수정 대상 선점
  - 유니크 제약: 중복 INSERT DB 레벨 차단
  - 멱등성 키: 동일 요청 중복 처리 방지
  - 자동 재시도 / 수동 재시도 패턴

  [ 참고 ]
  - docs-for-동시성 문제 (브랜드 관리)/ 폴더의 각 해결책 문서


3단계 — 미니 프로젝트에서 직접 구현
----------------------------------------------------------------
  [ 구현 대상 — 정산 시나리오 ]
  - 같은 정산 데이터에 동시 요청이 들어오는 상황 재현
  - SELECT FOR UPDATE로 중복 처리 방지
  - 외부 API(fnb-external-api) 호출을 트랜잭션 분리
  - 실패 시 sync_status 기록 + 재시도 스케줄러

  [ 학습 포인트 ]
  - @Transactional 경계 설계
  - MyBatis에서 SELECT FOR UPDATE 사용법
  - 동시성 테스트 작성 (CountDownLatch, ExecutorService)

  [ 참고 ]
  - docs-for-정산 시스템 동시성 문제 해결 연습 프로젝트에서 구현 해보기/

================================================================
